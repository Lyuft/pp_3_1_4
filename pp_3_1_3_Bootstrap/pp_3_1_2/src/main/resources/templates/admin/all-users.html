<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<nav class="navbar navbar-expand py-3" style="background-color: #0f0f0f;">
    <div class="container-fluid">
        <div class="navbar-text me-auto text-white">
            <strong class="text-white">
                <span id="navbarUserName">Загрузка...</span> :
                <span id="navbarUserRoles">-</span>
            </strong>
        </div>
        <a class="btn btn-outline-light btn-sm" href="/logout">Logout</a>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 d-md-block bg-light border-end p-3 min-vh-100">
            <a class="btn btn-outline-primary w-100 mb-2 d-block px-4" href="/admin">Admin Panel</a>
            <a class="btn btn-outline-primary w-100 mb-2 d-block px-4" href="/user">User Info Page</a>
        </div>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <div class="mb-4">
                <h2 class="mb-3">Users</h2>
                <div class="d-flex gap-2 justify-content-start mb-4">
                    <button id="showUsers" class="btn btn-outline-primary px-4 py-2 active" onclick="showSection('users')">All Users</button>
                    <button id="showAdd" class="btn btn-outline-primary px-4 py-2" onclick="showSection('add')">Add User</button>
                </div>
            </div>

            <div id="usersSection" class="section">
                <div class="card-body p-4">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Surname</th>
                                <th>Department</th>
                                <th>Salary</th>
                                <th>Login</th>
                                <th>Password</th>
                                <th>Role</th>
                                <th>Operations</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="addSection" class="section" style="display: none;">
                <div class="card mx-auto" style="max-width: 450px;">
                    <div class="card-header bg-primary text-white text-center py-3">
                        <h5 class="mb-0 fw-bold">Add new user!</h5>
                    </div>
                    <div class="card-body p-3">
                        <form id="addUserForm">
                            <input type="hidden" id="addUserId" value="">

                            <div class="mb-3 text-center">
                                <label for="firstName" class="form-label d-block fw-bold fs-6 mb-1 text-dark">First name</label>
                                <input type="text" id="firstName" class="form-control" style="max-width: 350px; margin: 0 auto; display: block;">
                            </div>

                            <div class="mb-3 text-center">
                                <label for="secondName" class="form-label d-block fw-bold fs-6 mb-1 text-dark">Last Name</label>
                                <input type="text" id="secondName" class="form-control" style="max-width: 350px; margin: 0 auto; display: block;">
                            </div>

                            <div class="mb-3 text-center">
                                <label class="form-label d-block fw-bold fs-6 mb-1 text-dark">Department</label>
                                <label for="department"></label><select id="department" class="form-select" style="max-width: 350px; margin: 0 auto; display: block;">
                                    <option value="">Choose department</option>
                                    <option value="IT">IT</option>
                                    <option value="HR">HR</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Marketing">Marketing</option>
                                </select>
                            </div>

                            <div class="mb-3 text-center">
                                <label class="form-label d-block fw-bold fs-6 mb-1 text-dark">Salary</label>
                                <label for="salary"></label><input type="number" id="salary" class="form-control" style="max-width: 350px; margin: 0 auto; display: block;">
                            </div>

                            <div class="mb-3 text-center">
                                <label class="form-label d-block fw-bold fs-6 mb-1 text-dark">Login</label>
                                <label for="username"></label><input type="text" id="username" class="form-control" style="max-width: 350px; margin: 0 auto; display: block;">
                            </div>

                            <div class="mb-3 text-center">
                                <label class="form-label d-block fw-bold fs-6 mb-1 text-dark">Password</label>
                                <label for="password"></label><input type="password" id="password" class="form-control" style="max-width: 350px; margin: 0 auto; display: block;" placeholder="Без изменений=старый пароль">
                            </div>

                            <div class="mb-4 text-center">
                                <label class="form-label d-block fw-bold fs-6 mb-2 text-dark">Roles</label>
                                <div class="d-inline-block text-start">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="role" value="ROLE_USER" id="roleUser">
                                        <label class="form-check-label" for="roleUser">User</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="role" value="ROLE_ADMIN" id="roleAdmin">
                                        <label class="form-check-label" for="roleAdmin">Admin</label>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" class="btn btn-success px-4 py-2 fs-6 fw-bold w-100 mb-2" onclick="saveUser()">Add User!</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>
</div>


<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="updateModalTitle">Update User Info</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateForm">
                <input type="hidden" id="editUserId">

                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editFirstName" class="form-label fw-bold">Name:</label>
                        <input type="text" name="firstName" id="editFirstName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editSecondName" class="form-label fw-bold">Surname:</label>
                        <input type="text" name="secondName" id="editSecondName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editDepartment" class="form-label fw-bold">Department:</label>
                        <select name="department" id="editDepartment" class="form-select">
                            <option value="">Выберете департамент</option>
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Sales">Sales</option>
                            <option value="Marketing">Marketing</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSalary" class="form-label fw-bold">Salary:</label>
                        <input type="number" name="salary" id="editSalary" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editUsername" class="form-label fw-bold">Login:</label>
                        <input type="text" name="username" id="editUsername" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="editPassword" class="form-label fw-bold">Password:</label>
                        <input type="password" name="password" id="editPassword" class="form-control" placeholder="Без изменений=старый пароль">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold d-block">Roles:</label>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="role" value="ROLE_USER" id="editRoleUser">
                            <label class="form-check-label" for="editRoleUser">
                                User
                            </label>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="role" value="ROLE_ADMIN" id="editRoleAdmin">
                            <label class="form-check-label" for="editRoleAdmin">
                                Admin
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveUpdate()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>



<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteModalTitle">Delete User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <input type="hidden" id="deleteUserId" value="">

                <div class="mb-3">
                    <label class="form-label fw-bold">ID:</label>
                    <label for="deleteUserIdDisplay"></label><input type="text" id="deleteUserIdDisplay" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Name:</label>
                    <label for="deleteUserName"></label><input type="text" id="deleteUserName" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Surname:</label>
                    <label for="deleteUserSecondName"></label><input type="text" id="deleteUserSecondName" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Department:</label>
                    <label for="deleteUserDept"></label><input type="text" id="deleteUserDept" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Salary:</label>
                    <label for="deleteUserSalary"></label><input type="number" id="deleteUserSalary" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Login:</label>
                    <label for="deleteUserLogin"></label><input type="text" id="deleteUserLogin" class="form-control bg-light" readonly>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Role:</label>
                    <label for="deleteUserRole"></label><input type="text" id="deleteUserRole" class="form-control bg-light" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = '/admin/api';

    // загрузка таблицы
    async function loadUsersTable() {
        try {
            const response = await fetch(API_BASE);
            const users = await response.json();

            document.getElementById('usersTableBody').innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.firstName || ''}</td>
                <td>${user.secondName || ''}</td>
                <td>${user.department || ''}</td>
                <td>${user.salary || ''}</td>
                <td>${user.username || ''}</td>
                <td>***</td>
                <td>${user.roles?.map(r => r.role).join(', ') || ''}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary me-1" onclick="editUser(${user.id})">Update</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                    </div>
                </td>
            </tr>
        `).join('');
        } catch (error) {
            alert('Ошибка загрузки пользователей: ' + error);
        }
    }

    // заполение данных для юзера в окне update
    async function editUser(id) {
        try {
            const response = await fetch(`${API_BASE}/${id}`);
            const user = await response.json();

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editFirstName').value = user.firstName || '';
            document.getElementById('editSecondName').value = user.secondName || '';
            document.getElementById('editDepartment').value = user.department || '';
            document.getElementById('editSalary').value = user.salary || 0;
            document.getElementById('editUsername').value = user.username || '';
            document.getElementById('editPassword').value = '';

            document.getElementById('editRoleUser').checked = user.roles?.some(r => r.role === 'ROLE_USER');
            document.getElementById('editRoleAdmin').checked = user.roles?.some(r => r.role === 'ROLE_ADMIN');

            document.getElementById('updateModalTitle').textContent = `Update: ${user.firstName} ${user.secondName}`;
            new bootstrap.Modal(document.getElementById('updateModal')).show();
        } catch (error) {
            alert('Ошибка загрузки: ' + error);
        }
    }

    // удаление юзера
    async function deleteUser(id) {
        try {
            const response = await fetch(`${API_BASE}/${id}`);
            const user = await response.json();

            document.getElementById('deleteUserId').value = user.id;
            document.getElementById('deleteUserIdDisplay').value = user.id;
            document.getElementById('deleteUserName').value = user.firstName || '';
            document.getElementById('deleteUserSecondName').value = user.secondName || '';
            document.getElementById('deleteUserDept').value = user.department || '';
            document.getElementById('deleteUserSalary').value = user.salary || '';
            document.getElementById('deleteUserLogin').value = user.username || '';
            document.getElementById('deleteUserRole').value = user.roles?.map(r => r.role).join(', ') || '';

            document.getElementById('deleteModalTitle').textContent = `Удалить: ${user.firstName} ${user.secondName}`;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        } catch (error) {
            alert('Ошибка: ' + error);
        }
    }

    // сохранение юзера после добавления
    async function saveUser() {
        const userData = {
            id: parseInt(document.getElementById('addUserId').value) || 0,
            firstName: document.getElementById('firstName').value,
            secondName: document.getElementById('secondName').value,
            department: document.getElementById('department').value,
            salary: parseInt(document.getElementById('salary').value),
            username: document.getElementById('username').value,
            password: document.getElementById('password').value
        };

        const roleNames = Array.from(document.querySelectorAll('input[name="role"]:checked')).map(cb => cb.value);

        try {
            const response = await fetch(`${API_BASE}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: userData, roleNames })
            });

            if (response.ok) {
                loadUsersTable();
                document.getElementById('addUserForm').reset();
                document.getElementById('addUserId').value = '';
                document.querySelector('#addUserForm button').textContent = 'Add User!';
                showSection('users', document.getElementById('showUsers'));
            } else {
                alert('Ошибка сервера');
            }
        } catch (error) {
            alert('Ошибка: ' + error);
        }
    }
    // сохранение изменений в update окне
    async function saveUpdate() {
        const userData = {
            id: parseInt(document.getElementById('editUserId').value) || 0,
            firstName: document.getElementById('editFirstName').value || '',
            secondName: document.getElementById('editSecondName').value || '',
            department: document.getElementById('editDepartment').value || '',
            salary: parseInt(document.getElementById('editSalary').value) || 0,
            username: document.getElementById('editUsername').value || '',
            password: document.getElementById('editPassword').value || ''
        };

        const roleCheckboxes = document.querySelectorAll('#updateModal input[name="role"]:checked');
        const roleNames = Array.from(roleCheckboxes).map(cb => cb.value);

        try {
            const response = await fetch(`${API_BASE}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: userData, roleNames })
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('updateModal')).hide();
                loadUsersTable();
            } else {
                alert('Ошибка сервера');
            }
        } catch (error) {
            alert('Ошибка сохранения: ' + error);
        }
    }


    // всплывающее окно, об подтверждении удаления
    async function confirmDelete() {
        const userId = document.getElementById('deleteUserId').value;
        try {
            await fetch(`${API_BASE}/${userId}`, { method: 'DELETE' });
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadUsersTable();
        } catch (error) {
            alert('Ошибка удаления: ' + error);
        }
    }
    // заполнение навбара
    async function loadUserInfo() {
        try {
            const response = await fetch(`${API_BASE}/me`);
            const user = await response.json();

            const userNameEl = document.getElementById('navbarUserName');
            const userRolesEl = document.getElementById('navbarUserRoles');

            if (user && user.username) {
                userNameEl.textContent = user.username;
                userRolesEl.textContent = user.roles?.map(r => r.role).join(' ') || 'USER';
            } else {
                userNameEl.textContent = 'Гость';
                userRolesEl.textContent = '-';
            }
        } catch (error) {
            console.error('Ошибка загрузки user info:', error);
            document.getElementById('navbarUserName').textContent = 'Ошибка';
        }
    }

    // показ активных секций
    function showSection(sectionName, button) {
        document.querySelectorAll('.section').forEach(section => section.style.display = 'none');
        document.getElementById(sectionName + 'Section').style.display = 'block';
        document.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        if (button) button.classList.add('active');
    }

    // инициализация функций
        document.addEventListener('DOMContentLoaded', () => {
        showSection('users', document.getElementById('showUsers'));
        loadUsersTable();
        loadUserInfo();
    });
</script>
</body>
</html>
